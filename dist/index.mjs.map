{"version":3,"sources":["../sdk/index.ts","../server/utils/error/error.constants.ts","../client/utils/trpc/trpc-client.utils.ts","../client/utils/supabase/supabase-client.utils.ts","../server/utils/challenge/clients/challenge-client-v1.ts"],"sourcesContent":["// (DB) Types:\n\nexport type { DbWallet, WalletInfo, WalletSource, RecoverableAccount } from \"@/prisma/types/types\";\n\nexport type {\n  Challenge as DbChallenge,\n  Session as DbSession,\n  UserProfile as DbUserProfile,\n} from \"@prisma/client\";\n\n\n// (DB) Enums:\n\nexport {\n  AuthProviderType,\n  Chain,\n  ExportType,\n  WalletPrivacySetting,\n  WalletSourceFrom,\n  WalletSourceType,\n  WalletStatus,\n} from \"@prisma/client\";\n\n\n// Auth:\n\nexport type { SupabaseUser, SupabaseUserMetadata } from \"@/server/utils/supabase/supabase.types\"\n\nexport type { AuthError as SupabaseAuthError } from \"@supabase/supabase-js\";\n\n\n// Errors:\n\nexport { ErrorMessages } from \"@/server/utils/error/error.constants\";\n\n\n// Clients:\n\nexport { createTRPCClient } from \"@/client/utils/trpc/trpc-client.utils\";\n\nexport { createSupabaseClient } from \"@/client/utils/supabase/supabase-client.utils\";\n\nexport { ChallengeClientV1 } from \"@/server/utils/challenge/clients/challenge-client-v1\";\n\nexport type { AppRouter } from \"@/server/routers/_app\";\n","export const ErrorMessages = {\n  // Wallets:\n  WALLET_NOT_FOUND: `Wallet not found.`,\n  WALLET_CANNOT_BE_ENABLED: `Wallet cannot be enabled.`,\n  WALLET_CANNOT_BE_DISABLED: `Wallet cannot be disabled.`,\n  WALLET_NO_PRIVACY_SUPPORT: \"Wallet does not support the privacy setting.\",\n  WALLET_ADDRESS_MISMATCH: \"Wallet address mismatch.\",\n  WALLET_NOT_VALID_FOR_ACCOUNT_RECOVERY: `Wallet cannot be used for account recovery.`,\n\n  // Shares:\n  WORK_SHARE_NOT_FOUND: `Work share not found.`,\n  WORK_SHARE_INVALIDATED: `Work share invalidated.`,\n  INVALID_SHARE: `Invalid share.`,\n\n  // Challenge:\n  CHALLENGE_NOT_FOUND: `Challenge not found. It might have been resolved already, or it might have expired.`,\n  CHALLENGE_INVALID: `Invalid challenge.`,\n  CHALLENGE_EXPIRED_ERROR: `Challenge expired.`,\n  CHALLENGE_MISSING_PK: `Missing public key.`,\n  CHALLENGE_UNEXPECTED_ERROR: `Unexpected error validating challenge.`,\n\n  // Recovery:\n  RECOVERY_ACCOUNTS_NOT_FOUND: `No recoverable accounts found.`,\n  RECOVERY_WALLETS_NOT_FOUND: `No recoverable account wallets found.`,\n  RECOVERY_MISSING_PUBLIC_KEY: `Missing public key.`,\n\n  // Generic:\n  NO_OP: \"This request is a no-op.\",\n} as const;\n","import { createTRPCClient as _createTRPCClient, httpBatchLink, TRPCLink } from \"@trpc/client\";\nimport type { AppRouter } from \"@/server/routers/_app\";\nimport superjson from \"superjson\";\nimport { observable } from \"@trpc/server/observable\";\n\nexport interface CreateTRPCClientOptions {\n  baseURL?: string;\n  trpcURL?: string;\n  authToken?: string | null;\n  deviceNonce?: string;\n  clientId?: string;\n  applicationId?: string;\n  onAuthError?: () => void;\n}\n\ninterface AuthLinkOptions {\n  /**\n   * Callback function to handle authentication errors\n   */\n  onAuthError?: () => void | Promise<void>;\n  /**\n   * Function to get the current auth token\n   */\n  getAuthTokenHeader: () => string | null;\n  /**\n   * Function to set the auth token\n   */\n  setAuthTokenHeader: (token: string | null) => void;\n}\n\nexport const authErrorLink = <TRouter extends AppRouter = AppRouter>(\n  opts: AuthLinkOptions\n): TRPCLink<TRouter> => {\n  return () => {\n    return ({ next, op }) => {\n      return observable((observer) => {\n        const unsubscribe = next(op).subscribe({\n          next(value) {\n            observer.next(value);\n          },\n          async error(err) {\n            if (err.data?.code === \"UNAUTHORIZED\") {\n              console.warn(\"ðŸš« Unauthorized access detected:\", {\n                path: op.path,\n                type: op.type,\n              });\n              const currentAuthToken = opts.getAuthTokenHeader();\n              if (currentAuthToken) {\n                await opts.onAuthError?.();\n                opts.setAuthTokenHeader(null);\n              }\n            }\n            observer.error(err);\n          },\n          complete() {\n            observer.complete();\n          },\n        });\n\n        return unsubscribe;\n      });\n    };\n  };\n};\n\nexport function createTRPCClient({\n  baseURL,\n  trpcURL,\n  onAuthError,\n  ...params\n}: CreateTRPCClientOptions) {\n  let authToken = params.authToken || null;\n  let deviceNonce = params.deviceNonce || \"\";\n  let clientId = params.clientId || \"\";\n  let applicationId = params.applicationId || \"\";\n\n  function getAuthTokenHeader() {\n    return authToken;\n  }\n\n  function setAuthTokenHeader(nextAuthToken: string | null) {\n    authToken = nextAuthToken || null;\n  }\n\n  function getDeviceNonceHeader() {\n    return deviceNonce;\n  }\n\n  function setDeviceNonceHeader(nextDeviceNonce: string) {\n    deviceNonce = nextDeviceNonce;\n  }\n\n  function getClientIdHeader() {\n    return clientId;\n  }\n\n  function setClientIdHeader(nextClientId: string) {\n    clientId = nextClientId;\n  }\n\n  function getApplicationIdHeader() {\n    return applicationId;\n  }\n\n  function setApplicationIdHeader(nextApplicationId: string) {\n    applicationId = nextApplicationId;\n  }\n\n  const url = trpcURL || (baseURL ? `${baseURL.replace(/\\/$/, \"\")}/api/trpc` : \"\");\n\n  if (!url) throw new Error(\"No `baseURL` or `trpcURL` provided.\");\n\n  const client = _createTRPCClient<AppRouter>({\n    links: [\n      authErrorLink({\n        onAuthError,\n        getAuthTokenHeader,\n        setAuthTokenHeader,\n      }),\n      httpBatchLink({\n        url,\n        transformer: superjson,\n        headers() {\n          if (!deviceNonce) {\n            throw new Error(`Missing device nonce header.`);\n          }\n\n          if (!clientId) {\n            throw new Error(`Missing client ID header.`);\n          }\n\n          return {\n            authorization: authToken ? `Bearer ${authToken}` : undefined,\n            \"x-device-nonce\": deviceNonce,\n            \"x-client-id\": clientId,\n            \"x-application-id\": applicationId,\n          };\n        },\n      }),\n    ],\n  });\n\n  return {\n    client,\n    getAuthTokenHeader,\n    setAuthTokenHeader,\n    getDeviceNonceHeader,\n    setDeviceNonceHeader,\n    getClientIdHeader,\n    setClientIdHeader,\n    getApplicationIdHeader,\n    setApplicationIdHeader,\n  };\n}\n","import { SupabaseClientOptions, createClient } from \"@supabase/supabase-js\";\n\nexport function createSupabaseClient(\n  supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || \"\",\n  supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || \"\",\n  supabaseOptions: SupabaseClientOptions<\"public\"> = {\n    auth: {\n      autoRefreshToken: true,\n      persistSession: true,\n      detectSessionInUrl: true,\n    },\n  }\n) {\n  return createClient(supabaseUrl, supabaseKey, supabaseOptions);\n}\n","import {\n  ChallengeClient,\n  ChallengeClientVersion,\n  ChallengeData,\n  ChallengeSolutionWithVersion,\n  SolveChallengeParams,\n} from \"@/server/utils/challenge/challenge.types\";\nimport {\n  AnonChallenge,\n  Challenge,\n  ChallengePurpose,\n  ChallengeType,\n} from \"@prisma/client\";\n\nconst CHALLENGES_WITHOUT_SHARE_HASH: ChallengePurpose[] = [\n  ChallengePurpose.SHARE_ROTATION,\n  ChallengePurpose.ACCOUNT_RECOVERY,\n  ChallengePurpose.SHARE_RECOVERY,\n];\n\n// We duplicate this function instead of importing it to as `challenge.utils.ts` imports `Config`, which throws an error\n// when imported in the browser:\n\nfunction isAnonChallenge(\n  challenge: Challenge | AnonChallenge\n): challenge is AnonChallenge {\n  return (\n    !!(challenge as AnonChallenge).chain &&\n    !!(challenge as AnonChallenge).address\n  );\n}\n\nfunction getChallengeRawData({ challenge, session, shareHash }: ChallengeData) {\n  const commonChallengeData = [\n    challenge.id,\n    challenge.createdAt.toISOString(),\n    challenge.value,\n    challenge.version,\n    session.id,\n    session.ip,\n    session.deviceNonce,\n    session.userAgent,\n  ].join(\"|\");\n\n  if (isAnonChallenge(challenge)) {\n    return `ANON|${commonChallengeData}|${challenge.chain}|${challenge.address}`;\n  }\n\n  if (\n    !shareHash &&\n    !CHALLENGES_WITHOUT_SHARE_HASH.includes(challenge.purpose)\n  ) {\n    throw new Error(\"Missing `shareHash`\");\n  }\n\n  return [\n    challenge.purpose,\n    commonChallengeData,\n    challenge.userId,\n    challenge.walletId,\n    shareHash,\n  ]\n    .filter(Boolean)\n    .join(\"|\");\n}\n\nconst CHALLENGE_CLIENT_VERSION = \"v1\" as const satisfies ChallengeClientVersion;\n\nconst IMPORT_KEY_ALGORITHM = {\n  name: \"RSA-PSS\",\n  hash: \"SHA-256\",\n} as const satisfies RsaHashedImportParams;\n\nconst SIGN_ALGORITHM = {\n  name: \"RSA-PSS\",\n  saltLength: 32,\n} as const satisfies RsaPssParams;\n\nasync function solveChallenge({\n  challenge,\n  session,\n  shareHash,\n  jwk,\n}: SolveChallengeParams) {\n  const challengeRawData = getChallengeRawData({\n    challenge,\n    session,\n    shareHash,\n  });\n  const challengeRawDataBuffer = Buffer.from(challengeRawData);\n\n  let signatureOrHashBuffer: ArrayBuffer;\n\n  if (\n    isAnonChallenge(challenge) ||\n    challenge.type === ChallengeType.SIGNATURE\n  ) {\n    if (!jwk) {\n      throw new Error(\"Missing `jwk` (JWK private key)\");\n    }\n\n    const privateKey = await crypto.subtle.importKey(\n      \"jwk\",\n      jwk,\n      IMPORT_KEY_ALGORITHM,\n      true,\n      [\"sign\"]\n    );\n\n    signatureOrHashBuffer = await crypto.subtle.sign(\n      SIGN_ALGORITHM,\n      privateKey,\n      challengeRawDataBuffer\n    );\n  } else {\n    signatureOrHashBuffer = await crypto.subtle.digest(\n      \"SHA-256\",\n      challengeRawDataBuffer\n    );\n  }\n\n  const signatureOrHashString = Buffer.from(signatureOrHashBuffer).toString(\n    \"base64\"\n  );\n\n  return `${CHALLENGE_CLIENT_VERSION}.${signatureOrHashString}` satisfies ChallengeSolutionWithVersion;\n}\n\n// This module should also be used on the client as-is.\n\nexport const ChallengeClientV1: ChallengeClient = {\n  version: CHALLENGE_CLIENT_VERSION,\n  importKeyAlgorithm: IMPORT_KEY_ALGORITHM,\n  signAlgorithm: SIGN_ALGORITHM,\n  getChallengeRawData,\n  solveChallenge,\n};\n"],"mappings":"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","names":[]}